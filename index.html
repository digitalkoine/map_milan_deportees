<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8' />
      <!--Set the name of the webpage as it appears in the browser tab-->
      <title>Deportati Nati a Milano</title>
      <!--Describe metadata within an HTML document-->
      <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
      <!--leaflet.css is the stylesheet for Leaflet, it is retrieved from a Content Delivery Network (CDN)-->
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" />
      <!--leaflet.js is the javascript code for Leaflet, it is retrieved from a Content Delivery Network (CDN)-->
      <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"></script>
      <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
      <!--Leaflet.Coordinates-0.1.5.min.js is the leaflet plugin used to show the mouse coordinates. For info check https://github.com/MrMufflon/Leaflet.Coordinates for additional info-->
      <script type="text/javascript" src="./js/Leaflet.Coordinates-0.1.5.min.js"></script>
      <!--Leaflet.Coordinates-0.1.5.min.js is the stylesheet of the Leaflet Coordinate plugin. For info check https://github.com/MrMufflon/Leaflet.Coordinates for additional info-->
	    <link rel="stylesheet" href="./css/Leaflet.Coordinates-0.1.5.css"/>
      <!--Autolinker.min.js is javascript script that is used in popup generated by qgis2web plugin of Qgis. It manages autolinks, i.e. automatic hyperlinking, when a predetermined set of keywords is automatically turned into hyperlinks. For info check https://github.com/gregjacobs/Autolinker.js/-->
      <script src="js/Autolinker.min.js"></script>
      <link rel="stylesheet" href="./css/leaflet-search.min.css"/>
      <script src="js/leaflet-search.js"></script>
      <script src="js/leaflet.geometryutil.js"></script>
      <script src="js/leaflet.almostover.js"></script>
      <script src="js/multi-style-layer.js"></script>
      <script src="js/leaflet-svg-shape-markers.js"></script>
      <script src="js/leaflet-arrowheads.js"></script>
      <script src="js/leaflet.polylineDecorator.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier-Leaflet/0.2.6/oms.min.js"></script>
      <link rel="stylesheet" href="./css/easy-button.css">
      <script src="js/easy-button.js"></script>
      <!--The iso8601.min.js is a javascript library for parsing of ISO 8601 durations. Takes a ISO 8601 formatted duration and returns an array with 6 elements, one per unit.
      The order of the units, starting with the first element of the array, is “year”, “month”, "week", “day”, “hour”, “minute”, “second”.
      It is retrieved from a Content Delivery Network (CDN). Check https://github.com/nezasa/iso8601-js-period-->
      <script type="text/javascript" src="./js/iso8601-js-period-master/iso8601.js"></script>
      <!--leaflet plugin to incorporate time capability and the time slider, check https://github.com/socib/Leaflet.TimeDimension-->
      <script type="text/javascript" src="https://cdn.rawgit.com/socib/Leaflet.TimeDimension/master/dist/leaflet.timedimension.min.js"></script>
      <link rel="stylesheet" href="https://cdn.rawgit.com/socib/Leaflet.TimeDimension/master/dist/leaflet.timedimension.control.min.css" />
      <!--<script type="text/javascript" src="./js/Leaflet.TimeDimension-master/dist/leaflet.timedimension.min.js"></script>
      <link rel="stylesheet" href="./js/Leaflet.TimeDimension-master/dist/leaflet.timedimension.control.min.css"/>-->
      <!--publications.geojson is the publication layer. It is outputted by qgis2web. The time attribute should be in a "dd/mm/yyyy hh:mm" format -->
      <!--<script src="./data/nascite_2_sex.geojson" type="text/javascript"></script>-->
      <script src="./data/arresti_3.geojson" type="text/javascript"></script>
      <script src="./data/prigioni_4.geojson" type="text/javascript"></script>
      <script src="./data/campodimistamento_5.geojson" type="text/javascript"></script>
      <script src="./data/campodisterminio_7.geojson" type="text/javascript"></script>
      <script src="./data/campodisterminiopostwarsopravvissuti_8.geojson" type="text/javascript"></script>
      <script src="./data/campodisterminiopostwardeceduti_9.geojson" type="text/javascript"></script>
      <script src="./data/percorsi_di_deportazione_10_new_times.geojson" type="text/javascript"></script>
      <script src="./data/percorsi_di_deportazione_10_birthplace.geojson" type="text/javascript"></script>
      <script src="./data/stazionedismistamento_6.geojson" type="text/javascript"></script>
      <script src="./data/convoy_5.geojson" type="text/javascript"></script>
      <script src="./data/convoy_6.geojson" type="text/javascript"></script>
      <script src="./data/convoy_9.geojson" type="text/javascript"></script>
      <script src="./data/convoy_10.geojson" type="text/javascript"></script>
      <script src="./data/convoy_3.geojson" type="text/javascript"></script>
      <script src="./data/convoy_12.geojson" type="text/javascript"></script>
      <script src="./data/convoy_13.geojson" type="text/javascript"></script>
      <script src="./data/convoy_14.geojson" type="text/javascript"></script>
      <script src="./data/convoy_15.geojson" type="text/javascript"></script>
      <script src="./data/convoy_16.geojson" type="text/javascript"></script>
      <script src="./data/convoy_17.geojson" type="text/javascript"></script>
      <script src="./data/convoy_18.geojson" type="text/javascript"></script>
      <script src="./data/convoy_19.geojson" type="text/javascript"></script>
      <script src="./data/convoy_2.geojson" type="text/javascript"></script>
      <script src="./data/convoy_35t.geojson" type="text/javascript"></script>
      <script src="./data/convoy_23t.geojson" type="text/javascript"></script>
      <script src="./data/convoy_41t.geojson" type="text/javascript"></script>

      <!--MapStyle.css includes the css style for the text tags and ids element that can be used to format text -->
      <link rel="stylesheet" href="./css/MapStyle.css"/>
      <!--style_publications.js includes the style for both layers in the map. The code is as outputted by qgis2web for the different layers-->
      <script type="text/javascript" src="./js/layer_style.js"></script>
  </head>
  <body>
    <!--Create an element with id map-->
    <div id='map'></div>
    <!--Add the map with the TimeDimension parameters-->
    <script type="text/javascript" src="./js/timedimension_map.js"></script>
    <!--The extended L.timeDimension.Layer.GeoJSON that manages datasets with a start and end date-->
    <script type="text/javascript" src="./js/timedimension_layer_betweendates.js"></script>
    <!--The extended L.timeDimension.Layer.GeoJSON that manages datasets with lines whose segments must appear at different times-->
    <script type="text/javascript" src="./js/timedimension_layer_lines.js"></script>
    <!--The js function managing what happens when you hover over a concentration camp point-->
    <!--<script type="text/javascript" src="./js/eventHandlerOnEachFeature_birth.js"></script>-->
    <!--The js function managing what happens when you hover over a prison point-->
    <script type="text/javascript" src="./js/eventHandlerOnEachFeature_prison.js"></script>
    <!--The js function managing what happens when you hover over a concentration camp point-->
    <script type="text/javascript" src="./js/eventHandlerOnEachFeature_arrest.js"></script>
    <!--The js function managing what happens when you hover over a concentration camp point-->
    <script type="text/javascript" src="./js/eventHandlerOnEachFeature_concentration.js"></script>
    <!--The js function managing what happens when you hover over an extermination camp point-->
    <script type="text/javascript" src="./js/eventHandlerOnEachFeature_extermination.js"></script>
    <!--The js function managing what happens when you hover over an extermination camp point-->
    <script type="text/javascript" src="./js/eventHandlerOnEachFeature_intermediateStop.js"></script>
    <!--The js function managing what happens when you hover over an ex extermination camp point-->
    <script type="text/javascript" src="./js/eventHandlerOnEachFeature_extermination_postwar_survived.js"></script>
    <!--The js function managing what happens when you hover over an ex extermination camp point-->
    <script type="text/javascript" src="./js/eventHandlerOnEachFeature_extermination_postwar_deceased.js"></script>
    <script type="text/javascript" src="./js/timedimension_timebox.js"></script>

    <script>
      var searched_names=[]

      map.createPane('pane_jsonLayer_lines');
      map.getPane('pane_jsonLayer_lines').style.zIndex = 401;
      map.getPane('pane_jsonLayer_lines').style['mix-blend-mode'] = 'normal';

      var jsonLayer_lines=L.geoJson.multiStyle(line,{
        onEachFeature: function(feature, layer) {
          var prevLayerClicked = null
          layer.bindPopup(
            '<p>'+'<strong>'+feature.properties.name+'</strong>'+
            '<p>'+'Data di nascita: '+feature.properties.dateOfBirth_label+
            '<br>'+'Data di arresto a Milano e di trasferimento a '+feature.properties.detentionPlace+': '+feature.properties.arrestDate_label+
            '<br>'+'Data di arrivo a '+feature.properties.labelToNaziCamp+' con convoglio numero '+feature.properties.convoyNumber_1+': '+ feature.properties.convoyArrivalDate2+
            '<br>'+feature.properties.deathDescription+
            '</p>'
            );
          /*layer.on({
            'click': function(event) {
              if (prevLayerClicked !== null){
                event.target.setStyle({
                    pane: 'pane_jsonLayer_lines',
                    opacity: 1,
                    color: 'rgba(206,0,206,1.0)',
                    dashArray: '',
                    lineCap: 'round',
                    lineJoin: 'round',
                    weight: 0.2,
                    fill: false,
                    interactive: true,
                })
                prevLayerClicked = null
              }
              else {
                event.target.setStyle({
                    pane: 'pane_jsonLayer_lines',
                    opacity: 1,
                    color: 'yellow',
                    dashArray: '',
                    lineCap: 'round',
                    lineJoin: 'round',
                    weight: 4,
                    fill: false,
                    interactive: true,
                  });
                  //event.target.bringToFront();
                  prevLayerClicked = layer;
              }
            }
          });*/
        },
        pane: 'pane_jsonLayer_lines_second',
        styles:[style_line_1, style_line_0],
        arrowheads: {
          yawn:'90',
          fill: false,
          frequency: '2',
          size: '5px'
        }
      });

      map.createPane('pane_jsonLayer_lines_second');
      map.getPane('pane_jsonLayer_lines_second').style.zIndex = 400;
      map.getPane('pane_jsonLayer_lines_second').style['mix-blend-mode'] = 'normal';

      var jsonLayer_lines_second = L.geoJson(line,{
        onEachFeature: function(feature, layer){
          layer.bindPopup(
            '<p>'+'<strong>'+feature.properties.name+'</strong>'+
            '<p>'+'Data di nascita: '+feature.properties.dateOfBirth_label+
            '<br>'+'Data di arresto a Milano e di trasferimento a '+feature.properties.detentionPlace+': '+feature.properties.arrestDate+
            '<br>'+'Data di arrivo a '+feature.properties.labelToNaziCamp+' con convoglio numero '+feature.properties.convoyNumber_1+': '+ feature.properties.convoyArrivalDate2+
            '<br>'+feature.properties.deathDescription+
            '</p>'
            );
        },
        pane: 'pane_jsonLayer_lines_second',
        style:style_line_2,
        arrowheads: {
          yawn:'90',
          fill: false,
          frequency: '2',
          size: '5px'
        }
      });

      var jsonLayer_lines_time = L.TimeDimension.Layer.lines (jsonLayer_lines_second, {
        updateTimeDimensionMode: 'union', //changing this changes the way the point appear on the map
        duration: 'P0D',//how long the feature remains there until its time as passed
      });
      jsonLayer_lines_time.addTo(map);
      </script>
      <script type="text/javascript" src="./js/eventHandlerOnEachFeature_convoy.js"></script>
      <script>
      // Here we creates the legend map in the top right hand side corner.
      // baseMaps (which is empty here) is a radio button that allows to chose alternativelly between different basemaps (but only one at the time)
      // overlay are the layer that you turn on and off. The text is currently in HTML, and it is structured like a table calling the symbols from the legend folder. It is outputted directly from qgis2web
     var baseMaps = {};
     var overlay = {
       //'Luogo di nascita<table><tr><td><img src="./icons/logo_arrest_space.svg" width=15 height=15 /></td><td><img src="./icons/male.svg" width=20 height=20 /></td><td style="font-size:8pt; font-family:Helvetica" >Uomini</td></tr><tr><td></td><td><img src="./icons/female.svg" width=20 height=20 /></td><td style="font-size:8pt; font-family:Helvetica" >Donne</td></tr>': jsonLayer_birth_time,
       'Luogo di arresto<table><tr><td><img src="./icons/logo_arrest_space.svg" width=20 height=15 /></td><td><img src="./icons/logo_arrest_fascist-01.svg" width=10 height=10 /></td><td style="font-size:8pt; font-family:Helvetica" >ad opera di forze fasciste</td></tr><tr><td></td><td><img src="./icons/logo_arrest_nazist-01.svg" width=10 height=10 /></td><td style="font-size:8pt; font-family:Helvetica" >ad opera di forze naziste</td></tr><tr><td></td><td><img src="./icons/logo_arrest_nazifascist-01.svg" width=10 height=10 /></td><td style="font-size:8pt; font-family:Helvetica" >ad opera di forze nazifasciste</td></tr><tr><td></td><td><img src="./icons/logo_arrest_nodata-01.svg" width=10 height=10 /></td><td style="font-size:8pt; font-family:Helvetica" >sconosciuto</td></tr>': jsonLayer_arrest_time,
       '<img src="./icons/logo_prison-01.svg" width=15 height=15 /> Luoghi di detenzione':jsonLayer_prison_camps_time,
       '<img src="./icons/logo_concentration-01.svg" width=15 height=15 />  Campi di smistamento':jsonLayer_concentration_camps_time,
       '<img src="./icons/transport_train_station2.svg" width=15 height=15 />  Stazione di Verona':jsonLayer_intermediateStop_time,
       '<img src="./icons/logo_extermination-01.svg" width=15 height=15 />  Campi di concentramento':jsonLayer_extermination_camps_time,
       '<img src="./icons/logo_extermination_survived-01.svg" width=15 height=15 />  Sopravvissuti al campo di concentramento':jsonLayer_extermination_camps_postwar_survived_time,
       '<img src="./icons/logo_extermination_deceased-01.svg" width=15 height=15 />  Deceduti nel campo di concentramento':jsonLayer_extermination_camps_postwar_deceased_time,

       '<img src="./legend/convoy_0_2013.png" width=15 height=10 /> Convoglio numero 2':jsonLayer_convoy_2,
       '<img src="./legend/convoy_0_92.png" width=15 height=10 /> Convoglio numero 23T':jsonLayer_convoy_23t,
       '<img src="./legend/convoy_0_114.png" width=15 height=10 /> Convoglio numero 3':jsonLayer_convoy_3,
       '<img src="./legend/convoy_0_169.png" width=15 height=10 /> Convoglio numero 35T':jsonLayer_convoy_35t,
       '<img src="./legend/convoy_0_1912.png" width=15 height=10 /> Convoglio numero 41T':jsonLayer_convoy_41t,
       '<img src="./legend/convoy_0_50.png" width=15 height=10 /> Convoglio numero 5':jsonLayer_convoy_5,
       '<img src="./legend/convoy_0_61.png" width=15 height=10 /> Convoglio numero 6':jsonLayer_convoy_6,
       '<img src="./legend/convoy_0_92.png" width=15 height=10 /> Convoglio numero 9':jsonLayer_convoy_9,
       '<img src="./legend/convoy_0_103.png" width=15 height=10 /> Convoglio numero 10':jsonLayer_convoy_10,
       '<img src="./legend/convoy_0_125.png" width=15 height=10 /> Convoglio numero 12':jsonLayer_convoy_12,
       '<img src="./legend/convoy_0_136.png" width=15 height=10 /> Convoglio numero 13':jsonLayer_convoy_13,
       '<img src="./legend/convoy_0_147.png" width=15 height=10 /> Convoglio numero 14':jsonLayer_convoy_14,
       '<img src="./legend/convoy_0_158.png" width=15 height=10 /> Convoglio numero 15':jsonLayer_convoy_15,
       '<img src="./legend/convoy_0_169.png" width=15 height=10 /> Convoglio numero 16':jsonLayer_convoy_16,
       '<img src="./legend/convoy_0_1710.png" width=15 height=10 /> Convoglio numero 17':jsonLayer_convoy_17,
       '<img src="./legend/convoy_0_1811.png" width=15 height=10 /> Convoglio numero 18':jsonLayer_convoy_18,
       '<img src="./legend/convoy_0_1912.png" width=15 height=10 /> Convoglio numero 19':jsonLayer_convoy_19,
  }

     // This adds the control in the top right hand side with baseMaps as base maps and overlay as layers
     L.control.layers(baseMaps,overlay).addTo(map);

     var searchControlLine = new L.Control.Search({
       layer:jsonLayer_lines,
       propertyName: 'name',
       initial: false,
       marker: false,
       position:'topleft',
       autoCollapse:false,
       hideMarkerOnCollapse: false,
       textPlaceholder: 'Cerca persona nel dataset',
       textCancel: 'Cancel',
       firstTipSubmit: true,
       /*moveToLocation: function(latlng) {
         console.log(latlng)
         map.fitBounds( latlng.layer.getBounds() );
         var zoom = map.getBoundsZoom(latlng.layer.getBounds());
  			 map.setView(latlng, zoom); // access the zoom
       }*/
      });
     searchControlLine.on('search:locationfound', function(event) {
       var coordinate_x = event.layer.feature.geometry.coordinates[1][0]
       var coordinate_y = event.layer.feature.geometry.coordinates[1][1]
       var coordinates = [coordinate_y,coordinate_x]
       var zoom = 5
       map.setView(coordinates, zoom); // access the zoom
       searched_names.push(event.layer.feature.properties.name);
       event.layer.bringToFront()
      })
	   map.addControl(searchControlLine);

    var boxSearched = L.control({position: 'topright'});
    searchControlLine.on('search:locationfound', function(event) {
       boxSearched.onAdd = function (map){
         var div = L.DomUtil.create('div', 'searchBox');
         for (let i=0; i < searched_names.length; i++){
           for (var e=0; e< line.features.length;e++){
             var feature = line.features[e];
             var name = feature.properties.name;
             var dateOfBirth_label = feature.properties.dateOfBirth_label;
             if (name == searched_names[i]){
               div.innerHTML += '<h1>'+'<strong>'+feature.properties.name+'</strong>'+
               '</h1>'+'<p>'+'Data di nascita: '+feature.properties.dateOfBirth_label+'<p>'+
               '<p>'+'Data di arresto trasferimento a '+feature.properties.detentionPlace+': '+feature.properties.arrestDate_label+
               '<p>'+'Data di arrivo a '+feature.properties.labelToNaziCamp+' con convoglio numero '+feature.properties.convoyNumber_1+': '+ feature.properties.convoyArrivalDate2+
               '<p>'+feature.properties.deathDescription+
               '</p>'+'<br>'
             }
           }
         }
         return div;
       };
       boxSearched.addTo(map);
       jsonLayer_lines.setStyle(style_line_1);
     });

    L.easyButton('<img src="./icons/refresh-svgrepo-com.svg" style="height:15px; width:15px; margin-top:7px ; margin-left:1px">', function(btn, map) { // Function to forward the story when clicking in the map
    // If this was the last story do the same, but show the start styry and start again.
    searched_names=[];
     map.removeControl(boxSearched);
     jsonLayer_lines.setStyle(style_line_1);
 }).addTo(map);

 var boxInfo = L.control({position: 'topright'});

 boxInfo.onAdd = function (map){
    var div = L.DomUtil.create('div', 'searchBox');
    div.innerHTML += '<h1>'+'<strong>'+'Mappa degli ebrei nati a Milano, deportati dall’Italia nei campi di concentramento e sterminio nazisti (1943 – 1945)'+'</strong>'+'</h1>'+'<h2>'+'Questa mappa traccia e visualizza i trasferimenti forzati degli ebrei nati nella città di Milano, arrestati a Milano e in varie località d’Italia dopo l’8 settembre 1943.'+'<br>'+'Le persone identificate e presenti sulla mappa sono 162. Fra esse sono state incluse anche le 7 persone uccise nell’eccidio del Lago Maggiore (settembre - ottobre 1943) e le 5 persone morte in stato di detenzione prima della deportazione.'+'<br>'+ 'I dati e le informazioni utilizzate provengono da Fondazione Centro di Documentazione Ebraica Contemporanea CDEC. In particolare:'+'<br>'+'Liliana Picciotto, “Il Libro della Memoria. Gli ebrei deportati dall’Italia (1943-1945). Ricerca del Centro di Documentazione Ebraica Contemporanea”, Milano, Mursia, 2° ed., 2002;'+'<br>'+'Banca dati delle Vittime della Shoah, a cura di Liliana Picciotto e Alberta Bezzan;CDEC Digital Library, http://digital-library.cdec.it'+'<br>'+'Archivio Fondazione CDEC, Fondo Ricerca della deportazione 1972-1974, serie “Cartoteca”.'+'<br>'+'La mappa è stata realizzata da Giovanni Pietro Vitali (Université de Versailles Saint-Quentin-en-Yvelines) e Simone Landucci (GIS Developer)'+'</h2>'
   return div;
        }

 boxInfoAdded = 0
  L.easyButton('<img src="./icons/info.svg" style="height:15px; width:15px; margin-top:7px ; margin-left:1px">', function(btn, map) { // Function to forward the story when clicking in the map
  // If this was the last story do the same, but show the start styry and start again.
   if (boxInfoAdded==0){
     boxInfo.addTo(map)
     boxInfoAdded=1
   } else {
     map.removeControl(boxInfo);
     boxInfoAdded=0
   }
 }).addTo(map);


   </script>
</body>
</html>
